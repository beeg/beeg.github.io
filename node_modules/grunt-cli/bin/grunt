#!/usr/bin/env node

// Nodejs libs.
var fs = require('fs');
var path = require('path');

// External libs.
var nopt = require('nopt');

// Especially badass external lib.
var findup = require('findup-sync');

// Project metadata.
var pkg = require('../package.json');

// Parse CLI options we care about.
var known = {help: Boolean, version: Boolean};
var aliases = {h: '--help', V: '--version'};
var options = nopt(known, aliases, process.argv, 2);

// Display grunt-cli version.
function version() {
  console.log('grunt-cli v' + pkg.version);
}

// Exit with a message and error code.
function fatal(msg, code) {
  // Be sure to edit the help.splice(...) index below if necessary!
  var help = [
    'grunt-cli: ' + pkg.description + ' (v' + pkg.version + ')',
    '',
    'If you\'re seeing this message, either a Gruntfile wasn\'t found or grunt',
    'hasn\'t been installed locally to your project. For more information about',
    'installing and configuring grunt, please see the Getting Started guide:',
    '',
    'http://gruntjs.com/getting-started',
  ];

  if (options.version) {
    // Don't error if --version was specified, just dump the version and exit.
    version();
    code = 0;
  } else {
    // Don't error if --help was specified, just display the help and exit.
    if (options.help) {
      code = 0;
    } else {
      help.splice(1, 0, '', 'Fatal error: ' + msg);
    }
    help.forEach(function(str) { console.log(str); });
  }
  process.exit(code);
}

// Search for Gruntfile.
var gruntfile = findup('Gruntfile.{js,coffee}', {nocase: true});

// Gruntfile not found, look for pre-0.4.0 grunt.js file.
// TODO: remove, someday.
if (!gruntfile) {
  gruntfile = findup('grunt.js', {nocase: true});
}

// No Gruntfile found!
if (!gruntfile) {
  fatal('Unable to find Gruntfile.', 2);
}

// Where might a locally-installed grunt live?
var gruntpath = path.resolve(gruntfile, '../node_modules/grunt');

// If a local grunt isn't found, we might be grunting grunt itself.
// Check for grunt's grunt.js file.
if (!fs.existsSync(gruntpath)) {
  gruntpath = path.resolve(gruntfile, '../lib/grunt.js');
}

// No locally-installed grunt found!
if (!fs.existsSync(gruntpath)) {
  fatal('Unable to find local grunt.', 99);
}

// Run grunt.
var grunt = require(gruntpath);

// Display version number if asked.
if (options.version) {
  version();
}

grunt.cli();
